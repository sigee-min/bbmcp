name: ci

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      quality: ${{ steps.filter.outputs.quality }}
      plugin_desktop: ${{ steps.filter.outputs.plugin_desktop }}
      mcp_headless: ${{ steps.filter.outputs.mcp_headless }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed areas
        id: filter
        uses: dorny/paths-filter@v3
        with:
          token: ${{ github.token }}
          filters: |
            quality:
              - '.github/workflows/ci.yml'
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig.json'
              - 'scripts/**'
              - 'src/**'
              - 'packages/**'
              - 'apps/plugin-desktop/**'
              - 'apps/mcp-headless/**'
            plugin_desktop:
              - '.github/workflows/ci.yml'
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig.json'
              - 'scripts/esbuild.js'
              - 'src/**'
              - 'packages/contracts/**'
              - 'apps/plugin-desktop/**'
            mcp_headless:
              - '.github/workflows/ci.yml'
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig.json'
              - 'scripts/esbuild.js'
              - 'src/**'
              - 'packages/contracts/**'
              - 'apps/mcp-headless/**'
            docs:
              - '.github/workflows/ci.yml'
              - 'README.md'
              - 'docs/**'
              - 'apps/docs/**'

  quality:
    needs: detect-changes
    runs-on: ubuntu-latest
    steps:
      - name: Skip (no quality-impacting changes)
        if: needs.detect-changes.outputs.quality != 'true'
        run: echo "quality skipped (no matching changes)"

      - name: Checkout
        if: needs.detect-changes.outputs.quality == 'true'
        uses: actions/checkout@v4

      - name: Setup Node
        if: needs.detect-changes.outputs.quality == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install
        if: needs.detect-changes.outputs.quality == 'true'
        run: npm ci

      - name: ashfox quality gate
        if: needs.detect-changes.outputs.quality == 'true'
        run: npm run quality

  build-plugin-desktop:
    needs: detect-changes
    runs-on: ubuntu-latest
    steps:
      - name: Skip (no plugin-desktop changes)
        if: needs.detect-changes.outputs.plugin_desktop != 'true'
        run: echo "build:plugin-desktop skipped (no matching changes)"

      - name: Checkout
        if: needs.detect-changes.outputs.plugin_desktop == 'true'
        uses: actions/checkout@v4

      - name: Setup Node
        if: needs.detect-changes.outputs.plugin_desktop == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install
        if: needs.detect-changes.outputs.plugin_desktop == 'true'
        run: npm ci

      - name: Build plugin-desktop
        if: needs.detect-changes.outputs.plugin_desktop == 'true'
        run: npm run build:plugin-desktop

  build-mcp-headless:
    needs: detect-changes
    runs-on: ubuntu-latest
    steps:
      - name: Skip (no mcp-headless changes)
        if: needs.detect-changes.outputs.mcp_headless != 'true'
        run: echo "build:mcp-headless skipped (no matching changes)"

      - name: Checkout
        if: needs.detect-changes.outputs.mcp_headless == 'true'
        uses: actions/checkout@v4

      - name: Setup Node
        if: needs.detect-changes.outputs.mcp_headless == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install
        if: needs.detect-changes.outputs.mcp_headless == 'true'
        run: npm ci

      - name: Build mcp-headless
        if: needs.detect-changes.outputs.mcp_headless == 'true'
        run: npm run build:mcp-headless

  docs-static-check:
    needs: detect-changes
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/docs
    steps:
      - name: Skip (no docs changes)
        if: needs.detect-changes.outputs.docs != 'true'
        run: echo "docs build skipped (no matching changes)"

      - name: Checkout
        if: needs.detect-changes.outputs.docs == 'true'
        uses: actions/checkout@v4

      - name: Setup Node
        if: needs.detect-changes.outputs.docs == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: apps/docs/package-lock.json

      - name: Install docs dependencies
        if: needs.detect-changes.outputs.docs == 'true'
        run: npm ci

      - name: Build docs static site
        if: needs.detect-changes.outputs.docs == 'true'
        run: npm run build
        env:
          DOCS_SITE_URL: https://docs.example.com/

