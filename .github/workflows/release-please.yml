name: release-please

on:
  workflow_dispatch:
    inputs:
      bump:
        description: Version bump type for the release PR
        required: true
        default: auto
        type: choice
        options:
          - auto
          - patch
          - minor
          - major

concurrency:
  group: release-please-main
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve auth mode
        id: auth
        shell: bash
        env:
          RELEASE_PLEASE_TOKEN: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          RELEASE_PLEASE_ALLOW_GITHUB_TOKEN: ${{ vars.RELEASE_PLEASE_ALLOW_GITHUB_TOKEN }}
        run: |
          if [[ -n "${RELEASE_PLEASE_TOKEN}" ]]; then
            echo "mode=custom" >> "${GITHUB_OUTPUT}"
            echo "::notice::release-please will run with RELEASE_PLEASE_TOKEN."
          elif [[ "${RELEASE_PLEASE_ALLOW_GITHUB_TOKEN}" == "true" ]]; then
            echo "mode=github" >> "${GITHUB_OUTPUT}"
            echo "::notice::release-please will run with GITHUB_TOKEN (RELEASE_PLEASE_ALLOW_GITHUB_TOKEN=true)."
          else
            echo "mode=skip" >> "${GITHUB_OUTPUT}"
            echo "::notice::release-please skipped. Set RELEASE_PLEASE_TOKEN secret (recommended), or set RELEASE_PLEASE_ALLOW_GITHUB_TOKEN=true and enable GitHub Actions PR creation."
          fi

      - name: Resolve requested release version
        id: bump
        shell: bash
        env:
          INPUT_BUMP: ${{ inputs.bump }}
        run: |
          node <<'NODE'
          const fs = require('node:fs');

          const bump = String(process.env.INPUT_BUMP || 'auto').trim().toLowerCase();
          const out = process.env.GITHUB_OUTPUT;
          const currentVersion = JSON.parse(fs.readFileSync('package.json', 'utf8')).version;

          const match = String(currentVersion).match(/^(\d+)\.(\d+)\.(\d+)(?:[-+].*)?$/);
          if (!match) {
            throw new Error(`Invalid package.json version: ${currentVersion}`);
          }
          const major = Number(match[1]);
          const minor = Number(match[2]);
          const patch = Number(match[3]);

          if (bump === 'auto') {
            fs.appendFileSync(out, 'mode=auto\n');
            fs.appendFileSync(out, 'release_as=\n');
            console.log(`release-please bump=auto (conventional commits), current=${currentVersion}`);
            process.exit(0);
          }

          const next = (() => {
            if (bump === 'major') return `${major + 1}.0.0`;
            if (bump === 'minor') return `${major}.${minor + 1}.0`;
            if (bump === 'patch') return `${major}.${minor}.${patch + 1}`;
            throw new Error(`Unsupported bump input: ${bump}`);
          })();

          fs.appendFileSync(out, 'mode=forced\n');
          fs.appendFileSync(out, `release_as=${next}\n`);
          console.log(`release-please bump=${bump}, current=${currentVersion}, release_as=${next}`);
          NODE

      - name: Run release-please (PAT, auto)
        if: steps.auth.outputs.mode == 'custom' && steps.bump.outputs.mode == 'auto'
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          command: manifest
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
          # GitHub release publication is handled by release-major.yml
          skip-github-release: true

      - name: Run release-please (PAT, forced)
        if: steps.auth.outputs.mode == 'custom' && steps.bump.outputs.mode == 'forced'
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          command: manifest
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
          release-as: ${{ steps.bump.outputs.release_as }}
          # GitHub release publication is handled by release-major.yml
          skip-github-release: true

      - name: Run release-please (GITHUB_TOKEN fallback, auto)
        if: steps.auth.outputs.mode == 'github' && steps.bump.outputs.mode == 'auto'
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ github.token }}
          command: manifest
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
          # GitHub release publication is handled by release-major.yml
          skip-github-release: true

      - name: Run release-please (GITHUB_TOKEN fallback, forced)
        if: steps.auth.outputs.mode == 'github' && steps.bump.outputs.mode == 'forced'
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ github.token }}
          command: manifest
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
          release-as: ${{ steps.bump.outputs.release_as }}
          # GitHub release publication is handled by release-major.yml
          skip-github-release: true
